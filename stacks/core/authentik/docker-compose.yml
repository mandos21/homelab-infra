version: "3.9"

services:
  postgres:
    image: docker.io/postgres:16-alpine
    container_name: authentik-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${PG_DB:-authentik}
      POSTGRES_USER: ${PG_USER:-authentik}
      POSTGRES_PASSWORD: ${PG_PASS}
    volumes:
      - /mnt/user/appdata/authentik/postgres:/var/lib/postgresql/data
    networks:
      - authentik

  redis:
    image: docker.io/redis:7-alpine
    container_name: authentik-redis
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    volumes:
      - /mnt/user/appdata/authentik/redis:/data
    networks:
      - authentik

  server:
    image: ghcr.io/goauthentik/server:latest
    container_name: authentik-server
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
    environment:
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}

      # Only needed on first boot â€“ after that you can remove them if you want.
      AUTHENTIK_BOOTSTRAP_EMAIL: ${AUTHENTIK_BOOTSTRAP_EMAIL}
      AUTHENTIK_BOOTSTRAP_PASSWORD: ${AUTHENTIK_BOOTSTRAP_PASSWORD}
      AUTHENTIK_BOOTSTRAP_TOKEN: ${AUTHENTIK_BOOTSTRAP_TOKEN}

      AUTHENTIK_POSTGRESQL__HOST: postgres
      AUTHENTIK_POSTGRESQL__PORT: 5432
      AUTHENTIK_POSTGRESQL__NAME: ${PG_DB:-authentik}
      AUTHENTIK_POSTGRESQL__USER: ${PG_USER:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${PG_PASS}

      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_REDIS__PORT: 6379

      AUTHENTIK_EMAIL__HOST: ${AUTHENTIK_EMAIL__HOST}
      AUTHENTIK_EMAIL__PORT: ${AUTHENTIK_EMAIL__PORT}
      AUTHENTIK_EMAIL__USERNAME: ${AUTHENTIK_EMAIL__USERNAME}
      AUTHENTIK_EMAIL__PASSWORD: ${AUTHENTIK_EMAIL__PASSWORD}
      AUTHENTIK_EMAIL__USE_TLS: "true"
      AUTHENTIK_EMAIL__FROM: ${AUTHENTIK_EMAIL__FROM}

      # Used for redirect URLs etc.
      AUTHENTIK_HOST: id2.mdegenaro.com

    ports:
      - "9009:9000"   # HTTP
      - "9443:9443"   # HTTPS (self-signed)

    volumes:
      - /mnt/user/appdata/authentik/media:/media
      - /mnt/user/appdata/authentik/templates:/templates

    networks:
      - authentik
      # - traefik-proxy

    # labels:
    #   traefik.enable: "true"
    #   traefik.docker.network: traefik-proxy
    #   traefik.http.routers.authentik.rule: Host(`id2.mdegenaro.com`)
    #   traefik.http.routers.authentik.entrypoints: websecure
    #   traefik.http.routers.authentik.tls.certresolver: letsencrypt
    #   traefik.http.services.authentik.loadbalancer.server.port: 9000

  worker:
    image: ghcr.io/goauthentik/server:latest
    container_name: authentik-worker
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
    command: ["worker"]
    environment:
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}

      AUTHENTIK_POSTGRESQL__HOST: postgres
      AUTHENTIK_POSTGRESQL__PORT: 5432
      AUTHENTIK_POSTGRESQL__NAME: ${PG_DB:-authentik}
      AUTHENTIK_POSTGRESQL__USER: ${PG_USER:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${PG_PASS}

      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_REDIS__PORT: 6379

    volumes:
      - /mnt/user/appdata/authentik/media:/media
      - /mnt/user/appdata/authentik/templates:/templates

    networks:
      - authentik

networks:
  authentik:
    driver: bridge
  # traefik-proxy:
  #   external: true
