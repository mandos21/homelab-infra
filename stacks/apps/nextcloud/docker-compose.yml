services:
  mariadb:
    image: lscr.io/linuxserver/mariadb:11.4.8-r0-ls199
    container_name: nc-mariadb
    restart: unless-stopped
    environment:
      PUID: "99"
      PGID: "100"
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - /mnt/user/appdata/mariadb:/config
    ports:
      - "3306:3306"
    networks:
      - nextcloud-net

  redis:
    # If you prefer a different Redis 7.x tag, swap it here
    image: redis:7.4-alpine
    container_name: nc-redis
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    # No volume: we only use Redis for caching/locking, not durable data
    networks:
      - nextcloud-net

  nextcloud:
    image: lscr.io/linuxserver/nextcloud:32.0.1-ls403
    container_name: apps-nextcloud
    restart: unless-stopped
    depends_on:
      - mariadb
      - redis
    environment:
      PUID: "99"
      PGID: "100"
      TZ: "America/New_York"
      PHP_MEMORY_LIMIT: "2048M"
      PHP_UPLOAD_LIMIT: "2048M"
      # Tell Nextcloud how to reach Redis (hostname = service name above)
      REDIS_HOST: redis
      # Optional LSIO settings
      # DOCKER_MODS: "linuxserver/mods:nextcloud-libreoffice"
    labels:
      traefik.enable: "true"
      traefik.docker.network: traefik-proxy

      traefik.http.routers.nextcloud.rule: "Host(`cloud.dege.app`)"
      traefik.http.routers.nextcloud.entrypoints: websecure
      traefik.http.routers.nextcloud.tls: "true"
      traefik.http.routers.nextcloud.tls.certresolver: letsencrypt

      traefik.http.services.nextcloud.loadbalancer.server.port: 443
      traefik.http.services.nextcloud.loadbalancer.server.scheme: https
    
    volumes:
      - /mnt/user/appdata/nextcloud:/config
      - /mnt/user/nextData:/data
    ports:
      - "444:443"
    networks:
      - nextcloud-net
      - traefik-proxy

networks:
  nextcloud-net:
    driver: bridge
  traefik-proxy:
    external: true
