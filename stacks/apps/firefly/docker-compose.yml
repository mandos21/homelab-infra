version: "3.8"

services:
  db:
    image: mariadb:lts
    container_name: firefly_iii_db
    restart: unless-stopped
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"
      MYSQL_DATABASE: "firefly"
      MYSQL_USER: "firefly"
      MYSQL_PASSWORD: "${DB_PASSWORD}"
    volumes:
      - firefly_iii_db:/var/lib/mysql
    networks:
      - firefly_iii

  app:
    image: fireflyiii/core:latest
    container_name: firefly_iii_core
    restart: unless-stopped
    depends_on:
      - db
    ports:
      - "8086:8080"  # local access
    volumes:
      - firefly_iii_upload:/var/www/html/storage/upload
    environment:
      # --- Core required ---
      APP_ENV: "production"
      APP_DEBUG: "false"
      APP_KEY: "${APP_KEY}"                 # 32 chars as in your example
      APP_URL: "https://finances.dege.app"      # change later to https://firefly.yourdomain.tld
      SITE_OWNER: "${SITE_OWNER}"
      TZ: "${TZ:-America/New_York}"

      LOG_CHANNEL: "${LOG_CHANNEL:-stack}"
      APP_LOG_LEVEL: "${APP_LOG_LEVEL:-notice}"

      DB_CONNECTION: "mysql"
      DB_HOST: "db"
      DB_PORT: "3306"
      DB_DATABASE: "firefly"
      DB_USERNAME: "firefly"
      DB_PASSWORD: "${DB_PASSWORD}"

      # --- Mail (fill these out in Portainer env vars) ---
      MAIL_MAILER: "${MAIL_MAILER:-smtp}"
      MAIL_HOST: "${MAIL_HOST}"
      MAIL_PORT: "${MAIL_PORT:-587}"
      MAIL_FROM: "${MAIL_FROM}"
      MAIL_USERNAME: "${MAIL_USERNAME}"
      MAIL_PASSWORD: "${MAIL_PASSWORD}"
      MAIL_ENCRYPTION: "${MAIL_ENCRYPTION:-tls}"
      MAIL_ALLOW_SELF_SIGNED: "${MAIL_ALLOW_SELF_SIGNED:-false}"
      MAIL_VERIFY_PEER: "${MAIL_VERIFY_PEER:-true}"
      MAIL_VERIFY_PEER_NAME: "${MAIL_VERIFY_PEER_NAME:-true}"

      TRUSTED_PROXIES: "**"
      COOKIE_SECURE: "true"

    networks:
      - firefly_iii
      - traefik-proxy

    labels:
      traefik.enable: "true"
      traefik.docker.network: traefik-proxy
      traefik.http.routers.firefly.rule: Host(`finances.dege.app`)
      traefik.http.routers.firefly.entrypoints: websecure
      traefik.http.routers.firefly.tls.certresolver: letsencrypt
      traefik.http.services.firefly.loadbalancer.server.port: 8080
      traefik.http.middlewares.firefly-forwarded.headers.customrequestheaders.X-Forwarded-Proto: "https"
      traefik.http.middlewares.firefly-forwarded.headers.customrequestheaders.X-Forwarded-Port: "443"
      traefik.http.middlewares.firefly-forwarded.headers.customrequestheaders.X-Forwarded-Host: "finances.dege.app"

  cron:
    image: alpine:3
    container_name: firefly_iii_cron
    restart: unless-stopped
    depends_on:
      - app
    environment:
      TZ: "${TZ:-America/New_York}"
      STATIC_CRON_TOKEN: "${STATIC_CRON_TOKEN}"  # 32 chars
    command: >
      sh -c "apk add --no-cache tzdata wget &&
             (ln -fs /usr/share/zoneinfo/$TZ /etc/localtime || true) &&
             echo '0 3 * * * wget -qO- http://app:8086/api/v1/cron/'$$STATIC_CRON_TOKEN'; echo' | crontab - &&
             crond -f -L /dev/stdout"
    networks:
      - firefly_iii

  importer:
    image: fireflyiii/data-importer:latest
    container_name: firefly_iii_importer
    restart: unless-stopped
    depends_on:
      - app
    ports:
      - "8181:8080"  # local access
    environment:
      TZ: "${TZ:-America/New_York}"

      # Minimum for local use:
      FIREFLY_III_URL: "https://finances.dege.app"
      # Most auth details can be entered in the importer UI, but you CAN also set:
      # FIREFLY_III_ACCESS_TOKEN: "${FIREFLY_III_ACCESS_TOKEN}"
      # FIREFLY_III_CLIENT_ID: "${FIREFLY_III_CLIENT_ID}"

    networks:
      - firefly_iii
      # - traefik-proxy

volumes:
  firefly_iii_db:
  firefly_iii_upload:

networks:
  firefly_iii:
    driver: bridge

  traefik-proxy:
    external: true

